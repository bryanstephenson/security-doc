<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook"
  xmlns:xi="http://www.w3.org/2001/XInclude"
  xmlns:xlink="http://www.w3.org/1999/xlink"
  version="5.0"
  xml:id="object-storage">
    <?dbhtml stop-chunking?>
    <title>Object Storage</title>
    <para>OpenStack Object Storage (swift) is a service that provides
        software that stores and retrieves data over HTTP. Objects
        (blobs of data) are stored in an organizational hierarchy
        that offers anonymous read-only access, ACL defined access,
        or even temporary access.  Object Store supports multiple
        token-based authentication mechanisms implemented via
        middleware.</para>
    <para>Applications store and retrieve data in Object Store via an
        industry-standard HTTP RESTful API.  Back-end components of
        Object Storage follow the same RESTful model however some of the APIs
        for managing durability, for example, are kept private to the
        cluster. For more details on the API see the
            <link
            xlink:href="http://docs.openstack.org/api/openstack-object-storage/1.0/content/"
            >OpenStack Storage documentation</link>.</para>
    <para>For this document the components will be grouped into the
        following primary groups:</para>
    <orderedlist>
        <listitem>
            <para>Proxy services</para>
        </listitem>
        <listitem>
            <para>Auth services</para>
        </listitem>
        <listitem>
            <para>Storage services</para>
            <itemizedlist>
                <listitem>
                    <para>Account service</para>
                </listitem>
                <listitem>
                    <para>Container service</para>
                </listitem>
                <listitem>
                    <para>Object service</para>
                </listitem>
            </itemizedlist>
        </listitem>
    </orderedlist>
    <figure>
        <title>An example diagram from the OpenStack Object Storage
            Administration Guide (2013)</title>
        <mediaobject>
            <imageobject>
                <imagedata contentdepth="329" contentwidth="494"
                    fileref="static/swift_network_diagram-1.png"
                    format="PNG" scalefit="1"/>
            </imageobject>
        </mediaobject>
    </figure>
    <note>
        <para>An Object Storage installation does not have to
            necessarily be on the Internet and could also be a private
            cloud with the "Public Switch" being part of the
            organization's internal network infrastructure.</para>
    </note>
    <section xml:id="object-storage-idpA">
        <title>First thing to secure: the network</title>
        <para>The first aspect of a secure architecture design for
            Object Storage is in the networking component. The proxy servers
            communicate with both the public side of the cluster
            and the private side.  On the public side, the proxy servers
            communicate with applications (control and data) while
            on the private side they communicate with the storage nodes
            for both data transfer and inter-node communication.</para>
        <caution>
            <para>Object Storage does not employ encryption or authentication
            with inter-node communications. This is why you see a
            "Private Switch" or private network ([V]LAN) in architecture
            diagrams. This data domain should be separate from other
            OpenStack data networks as well. For further discussion on
            security domains please see <xref
            linkend="security-boundaries-and-threats"
            />.</para>
        </caution>
        <tip>
            <para><emphasis>Rule:</emphasis> Use a private (V)LAN
                network segment for your storage nodes in the data
                domain.</para>
        </tip>
        <para>This necessitates that the proxy nodes have dual
            interfaces (physical or virtual):</para>
        <orderedlist>
            <listitem>
                <para>One as a "public" interface for consumers to
                    reach</para>
            </listitem>
            <listitem>
                <para>Another as a "private" interface with access to
                    the storage nodes</para>
            </listitem>
        </orderedlist>
        <para>The following figure demonstrates one possible network
            architecture.</para>
        <figure>
            <title>Object Storage network architecture with a
                management node (OSAM)</title>
            <mediaobject>
                <imageobject role="html">
                    <imagedata contentdepth="913" contentwidth="1264"
                        fileref="static/swift_network_diagram-2.png"
                        format="PNG" scalefit="1"/>
                </imageobject>
                <imageobject role="fo">
                    <imagedata contentdepth="100%"
                        fileref="static/swift_network_diagram-2.png"
                        format="PNG" scalefit="1" width="100%"/>
                </imageobject>
            </mediaobject>
        </figure>
    </section>
    <!-- First thing to secure - The Network -->
    <section xml:id="object-storage-idpC1">
        <title>Securing services: general</title>
        <section xml:id="object-storage-idpC12">
            <title>Service runas user</title>
            <para>It is recommended that you configure each Object Storage service

                to run under a non-root (UID 0) service account. One
                recommendation is the user name "swift" with primary
                group "swift."  Object Storage services include, for
                example, 'proxy-server', 'container-server',
                'account-server'.  Detailed steps for setup and
                configuration can be found in the <link
                xlink:href="http://docs.openstack.org/icehouse/install-guide/install/apt/content/ch_swift.html">Add
                Object Storage chapter</link> of the
                <citetitle>Installation Guide</citetitle> in the <link
                xlink:href="http://docs.openstack.org" >OpenStack
                Documentation index</link>. (The link defaults to the
                Ubuntu version.)</para>
        </section>
        <section xml:id="object-storage-idpC123">
            <title>File permissions</title>
            <para>The <filename>/etc/swift</filename> directory
               contains information about the ring topology and
               environment configuration. The following permissions are
               recommended:</para>
            <screen><prompt>#</prompt> <userinput>chown -R root:swift /etc/swift/*</userinput>
<prompt>#</prompt> <userinput>find /etc/swift/ -type f -exec chmod 640 {} \;</userinput>
<prompt>#</prompt> <userinput>find /etc/swift/ -type d -exec chmod 750 {} \;</userinput></screen>
            <para>This restricts only root to be able to modify
                configuration files while allowing the services to
                read them through their group membership in
                the 'swift' group.</para>
        </section>
    </section>
    <!-- Securing Services - General -->
    <section xml:id="object-storage-idpD1">
        <title>Securing storage services</title>
        <para>The following are the default listening ports for the
            various storage services:</para>
        <informaltable>
            <thead>
                <tr>
                    <td>Service name</td>
                    <td>Port</td>
                    <td>Type</td>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Account service</td>
                    <td>6002</td>
                    <td>TCP</td>
                </tr>
                <tr>
                    <td>Container service</td>
                    <td>6001</td>
                    <td>TCP</td>
                </tr>
                <tr>
                    <td>Object service</td>
                    <td>6000</td>
                    <td>TCP</td>
                </tr>
                <tr>
                    <td>Rsync<footnote><para>If ssync is used
                    instead of rsync, the Object service port is used
                    for maintaining durability.</para></footnote>
                    </td>
                    <td>873</td>
                    <td>TCP</td>
                </tr>
            </tbody>
        </informaltable>
        <para>Authentication does not take place at the storage
            nodes. If someone was able to connect to a storage
            node on one of these ports they could access or
            modify data without authentication. In order to secure
            against this issue you should follow the recommendations
            given previously about using a private storage
            network.</para>
        <section xml:id="object-storage-idpD12">
            <title>Object Storage "account" terminology</title>
            <para>An Object Storage "account" is not a user account or
                credential. The following explains the
                relations:</para>
            <informaltable>
                <tbody>
                    <tr>
                        <td>OpenStack Object Storage account</td>
                        <td>Collection of containers; not user
                            accounts or authentication. Which users
                            are associated with the account and how
                            they may access it depends on the
                            authentication system used. See
                            authentication systems later.</td>
                    </tr>
                    <tr>
                        <td>OpenStack Object Storage containers</td>
                        <td>Collection of objects. Metadata on the
                            container is available for ACLs. The
                            meaning of ACLs is dependent on the
                            authentication system used.</td>
                    </tr>
                    <tr>
                        <td>OpenStack Object Storage objects</td>
                        <td>The actual data objects. ACLs at the
                            object level are also possible with
                            metadata and are dependent on the
                            authentication system used.</td>
                    </tr>
                </tbody>
            </informaltable>
            <tip>
                <para>
                    <?dbhtml bgcolor="#DDFADE" ?><?dbfo bgcolor="#DDFADE" ?>
                    Another way of thinking about the above would be:
                    A single shelf (account) holds zero or more ->
                    buckets (containers) which each hold zero or more
                    -> objects. A garage (Object Storage cluster) may have
                    multiple shelves (accounts) with each shelf
                    belonging to zero or more users.</para>
            </tip>
            <para>At each level you may have ACLs that dictate who has
                what type of access. ACLs are interpreted based on
                what authentication system is in use. The two most
                common types of authentication providers used are
                Identity service (keystone) and TempAuth. Custom authentication providers
                are also possible. Please see the Object Storage
                Authentication section for more information.</para>
        </section>
    </section>
    <!-- Securing Storage Services -->
    <section xml:id="object-storage-idpE1">
        <title>Securing proxy services</title>
        <para>A proxy node should have at least two interfaces
            (physical or virtual): one public and one
            private. Firewalls or service binding might protect the
            public interface. The public facing service is an HTTP web
            server that processes end-point client requests,
            authenticates them, and performs the appropriate
            action. The private interface does not require any
            listening services but is instead used to establish
            outgoing connections to storage nodes on the
            private storage network.</para>
        <section xml:id="object-storage-idpE12">
            <title>Use SSL/TLS</title>
            <para>The built-in or included web server that comes with
                OpenStack Object Storage supports SSL, but it does not support
                transmission of the entire SSL certificate chain. This
                causes issues when you use a third party trusted and
                signed certificate, such as Verisign, for your cloud. The
                current work around is to not use the built-in web
                server but an alternative web server instead that
                supports sending both the public server certificate as
                well as the CA signing authorities intermediate
                certificate(s). This allows for end-point clients that
                have the CA root certificate in their trust store to
                be able to successfully validate your cloud
                environment's SSL certificate and chain. An example of
                how to do this with mod_wsgi and Apache is given
                below. Also consult the <link
                    xlink:href="http://docs.openstack.org/developer/swift/apache_deployment_guide.html"
                    >Apache Deployment Guide</link></para>
            <screen><prompt>#</prompt> <userinput>apt-get install libapache2-mod-wsgi</userinput></screen>
            <para>Modify file
                    <filename>/etc/apache2/envvars</filename>
                with</para>
            <programlisting>export APACHE_RUN_USER=swift
export APACHE_RUN_GROUP=swift</programlisting>
            <para>An alternative is to modify your Apache conf file
                with</para>
            <programlisting>User swift
Group swift</programlisting>
            <para>Create a <filename>swift</filename> directory in
               your Apache document root:</para>
            <screen><prompt>#</prompt> <userinput>mkdir /var/www/swift/</userinput></screen>
            <para>Create the file
                    <filename>$YOUR_APACHE_DOC_ROOT/swift/proxy-server.wsgi</filename>:</para>
            <programlisting>from swift.common.wsgi import init_request_processor application, conf, logger, log_name = \
  init_request_processor('/etc/swift/proxy-server.conf','proxy-server')</programlisting>
        </section>
        <section xml:id="object-storage-idpF1">
            <title>HTTP listening port</title>
            <para>You should configure your web service as a
                non-root (no UID 0) user such as "swift" mentioned
                before. The use of a port greater than 1024 is
                required to make this easy and avoid running any part
                of the web container as root. Doing so is not a burden
                as end-point clients are not typically going to type
                in the URL manually into a web browser to browse
                around in the object storage. Additionally, for
                clients using the HTTP REST API and performing
                authentication they will normally automatically grab
                the full REST API URL they are to use as provided by
                the authentication response. OpenStack's REST API
                allows for a client to authenticate to one URL and
                then be told to use a completely different URL for the
                actual service. Example: Client authenticates to
                    <uri>https://identity.cloud.example.org:55443/v1/auth</uri>
                and gets a response with their authentication key and
                Storage URL (the URL of the proxy nodes or load
                balancer) of
                    <uri>https://swift.cloud.example.org:44443/v1/AUTH_8980</uri>.</para>
            <para>The method for configuring your web server to start
                and run as a non-root user varies by web server and
                OS.</para>
        </section>
        <section xml:id="object-storage-idpG1">
            <title>Load balancer</title>
            <para>If the option of using Apache is not feasible or for
                performance you wish to offload your SSL work you may
                employ a dedicated network device load balancer. This
                is also the common way to provide redundancy and load
                balancing when using multiple proxy nodes.</para>
            <para>If you choose to offload your SSL ensure that the
                network link between the load balancer and your proxy
                nodes is on a private (V)LAN segment such that other
                nodes on the network (possibly compromised) cannot
                wiretap (sniff) the unencrypted traffic. If such a
                breach were to occur the attacker could gain access to
                end-point client or cloud administrator credentials
                and access the cloud data.</para>
            <para>The authentication service you use, such as
                Identity service (keystone) or TempAuth, will determine how you configure a
                different URL in the responses to end-clients so they
                use your load balancer instead of an individual proxy
                node.</para>
        </section>
    </section>
    <!-- Securing Proxy Services -->
    <section xml:id="object-storage-idpH1">
        <title>Object storage authentication</title>
        <para>Object Storage uses a WSGI model to provide for a middleware
            capability that not only provides general extensibility but
            is also used for authentication of end-point clients. The
            authentication provider defines what roles and user types
            exist. Some use traditional user name and password
            credentials while others may leverage API key tokens or
            even client-side x.509 SSL certificates. Custom providers
            can be integrated in using custom middleware.</para>
        <para>Object Storage comes with two authentication middleware modules
            by default, either of which can be used as sample code for
            developing a custom authentication middleware.</para>
        <section xml:id="object-storage-idpH123">
            <title>TempAuth</title>
            <para>TempAuth is the default authentication for
                Object Storage. In contrast to Identity it stores the user
                accounts, credentials, and metadata in object storage
                itself. More information can be found in the section
                    <link xlink:href="http://docs.openstack.org/developer/swift/overview_auth.html"
                    >The Auth System</link> of the Object Storage (swift) documentation.</para>
        </section>
        <section xml:id="object-storage-idpH12">
            <title>Keystone</title>
            <para>Keystone is the commonly used Identity provider in
                OpenStack. It may also be used for authentication in
                Object Storage. Coverage of securing keystone is
                already provided in <xref
                    linkend="identity"/>.</para>
        </section>
    </section>
    <!-- Object Storage Authentication -->
    <section xml:id="object-storage-idpI1">
        <title>Other notable items</title>
        <para>In <filename>/etc/swift/swift.conf</filename> on every
        node there is a
        <option>swift_hash_path_prefix</option> setting and a
        <option>swift_hash_path_suffix</option> setting. These are
        provided to reduce the chance of hash collisions for objects
        being stored and avert one user overwriting the data of
        another user.</para>
        <para>This value should be initially set with a
            cryptographically secure random number generator and
            consistent across all nodes. Ensure that it is
            protected with proper ACLs and that you have a backup copy
            to avoid data loss.</para>
    </section>
</chapter>
